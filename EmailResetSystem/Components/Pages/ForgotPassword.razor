@page "/ForgotPassword"
@using ResetSystem.Services
@inject UserService userService
@inject OtpService otpService
@inject SmsService smsService
@inject NavigationManager nav
@rendermode InteractiveServer

@inject EmailService emailService

<h3>Forgot Password (Email OTP)</h3>

<input class="form-control" @bind="Input" placeholder="Username or Email" />
<button class="btn btn-primary mt-2" @onclick="SendOtp">Send OTP</button>

<p class="text-danger">@Message</p>

@code {
    string Input;
    string Message;

    async Task SendOtp()
    {
        Message = string.Empty;
        if (string.IsNullOrWhiteSpace(Input))
        {
            Message = "Username বা Email দিন।";
            return;
        }

        var user = userService.GetUserByUsernameOrEmail(Input);
        if (user == null)
        {
            Message = "User পাওয়া যায়নি।";
            return;
        }

        var otp = otpService.GenerateOtp();
        userService.SaveOtp(user.Value.Username, otp);

        var html = $"<p>Your OTP is: <b>{otp}</b></p><p>Valid for 5 minutes.</p>";
        var sent = await emailService.SendEmailAsync(user.Value.Email, "Your OTP Code", html);

        if (sent)
        {
            nav.NavigateTo($"/VerifyOtp/{user.Value.Username}");
        }
        else
        {
            Message = "OTP পাঠাতে ব্যর্থ হয়েছে। SMTP settings চেক করুন।";
        }
    }
}
